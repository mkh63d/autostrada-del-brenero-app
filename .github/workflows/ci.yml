# =============================================================================
# CI/CD Pipeline - Build & Push Images
# Triggered on: push to main, pull requests
# =============================================================================
name: CI - Build & Push

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/autostrada

jobs:
  # ---------------------------------------------------------------------------
  # Detect which services changed
  # ---------------------------------------------------------------------------
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'docker-compose.yml'
            frontend:
              - 'frontend/**'
              - 'docker-compose.yml'
      
      - name: Set build matrix
        id: set-matrix
        run: |
          MATRIX="["
          if [ "${{ steps.filter.outputs.backend }}" == "true" ]; then
            MATRIX="${MATRIX}{\"service\":\"backend\",\"context\":\"./backend\",\"target\":\"production\"},"
          fi
          if [ "${{ steps.filter.outputs.frontend }}" == "true" ]; then
            MATRIX="${MATRIX}{\"service\":\"frontend\",\"context\":\"./frontend\",\"target\":\"production\"},"
          fi
          # Remove trailing comma and close bracket
          MATRIX="${MATRIX%,}]"
          # If nothing changed, build all
          if [ "$MATRIX" == "]" ]; then
            MATRIX='[{"service":"backend","context":"./backend","target":"production"},{"service":"frontend","context":"./frontend","target":"production"}]'
          fi
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------------
  # Build and push images
  # ---------------------------------------------------------------------------
  build:
    needs: changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.changes.outputs.matrix) }}
    
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}
          tags: |
            # On PR: pr-<number>
            type=ref,event=pr
            # On main: dev + sha-<commit>
            type=raw,value=dev,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha,prefix=sha-,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          target: ${{ matrix.target }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          build-args: |
            GIT_SHA=${{ github.sha }}

  # ---------------------------------------------------------------------------
  # Create deployment manifest artifact
  # ---------------------------------------------------------------------------
  manifest:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Create deployment manifest
        run: |
          mkdir -p artifacts
          cat > artifacts/deployment.json << EOF
          {
            "sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "images": {
              "backend": "${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-backend:sha-${GITHUB_SHA::7}",
              "frontend": "${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:sha-${GITHUB_SHA::7}"
            }
          }
          EOF
          cat artifacts/deployment.json
      
      - uses: actions/upload-artifact@v4
        with:
          name: deployment-manifest
          path: artifacts/deployment.json
          retention-days: 90
